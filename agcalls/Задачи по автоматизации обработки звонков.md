### Задачи по автоматизации обработки звонков

Ниже представлено детализированное описание решений по задачам автоматизации обработки звонков, создания демо-стенда и интеграции сервиса в бизнес-процессы.  

Описание включает архитектурные аспекты, используемые технологии и обоснования предпосылок, с учетом всех выполненных работ.

---

#### Задача 4: Автоматизация обработки обращений в колл-центре

**Описание:**
- **Архитектура:** система построена на двух этапах: предобработка аудио и классификация текста.
  - **Предобработка аудио:** 
    - Входной формат — wav, mp3, m4a и др.
    - Применяется  шумоподавление (`noisereduce.reduce_noise`), нормализация (`librosa.util.normalize`), усиление речевых частот (`librosa.effects.preemphasis`) и экстракция тишины (`pydub.silence.split_on_silence`). 
    - Выходной формат — WAV с частотой дискретизации 16 кГц.
  - **Транскрипция:** 
    - Модель Whisper (`WhisperForConditionalGeneration`) с процессором `WhisperProcessor`, адаптированная для русского языка с ограничением `max_length=1000`.
  - **Классификация:** 
    - Категории: `Покупка автомобиля`, `Сервис и обслуживание автомобиля`, `Кузовной ремонт`, `Финансовые вопросы`, `Вопрос оператору`, `Нецелевой звонок`. 
    - Синтетический датасет `train_sentences.csv` с короткими характерными предложениями (например, "Какие модели автомобилей могут быть у вас в наличии?"), размеченый по соответсвующим категориям.
    - Дообученная модель `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2` с кастомным классификатором (`CustomSentenceTransformer`) и оптимизацией в ONNX. 
    - Метрики: accuracy 0.9718, weighted F1-score 0.9717 (см. ноутбук).
  - **Контекстный анализ:** 
    - Функция `extract_keywords` и `find_car_brands` (см. ноутбук`) выделяют ключевые слова и марки автомобилей (например, Hyundai, Toyota).
- **Оптимизация:** 
  - Применены квантизация, прунинг и экспорт в ONNX для снижения вычислительной нагрузки.
- **Тестирование:** 
  - Пройдено 6 тестов на точность классификации (файл `test_api.py`).

**Предпосылки:**
- **Нагрузка на колл-центр:** необходимость оптимизации ресурсов для обработки большого количества звонков потребовало разработки автоматического локального решения.
- **Качество аудио:** реальные записи содержат шум и искажения (SNR < 20 дБ), что учтено в предобработке.
- **Коммерческая тайна:** исключение внешних API (Google Speech, AWS Transcribe) привело к использованию локальных моделей и синтетического датасета (сгенерирован и сохранен в `train_sentences.csv`).
- **Улучшение качества:** сравнение дообученной модели с базовой показало рост уверенности с ~0.6 до ~0.97 (по F1-score).

**Технические качества:**
- Масштабируемость: поддержка параллельной обработки через Celery.
- Безопасность: данные остаются внутри инфраструктуры.

---

#### Задача 6: Демо-стенд для внешних заказчиков

**Описание:**
- **Интерфейс:** Gradio-приложение (`demo_app.py`) с двумя вкладками:
  - классификация текста -- входной `Textbox`, выходной `Textbox` с вероятностями категорий.
  - обработка аудио -- входной `Audio` (WAV, ≤30 сек), выходные `Textbox` (транскрипция, классификация), `Audio` (обработанный файл), `Image` (графики волн и спектрограмм).
- **Оптимизация:** асинхронная транскрипция через Celery с Redis-брокером, классификация через ONNX-модель.
- **Развертывание:** Docker-образ (`Dockerfile`) с Supervisord для управления процессами API и Gradio, экспозиция портов 8000 (API) и 7860 (Gradio).
- **Визуализация:** генерация графиков обработки через `matplotlib` и `seaborn` (см. `api_app.py`).

**Предпосылки:**
- **Пользовательский опыт:** требование простоты для заказчиков исключило технические детали, фокусируясь на UX.
- **Демонстрация процесса:** необходимость показать полный цикл (транскрипция → классификация → визуализация) определила структуру интерфейса.
- **Нагрузка:** ограниченные ресурсы бэкенда учтены через ONNX-оптимизацию и асинхронность Celery.

**Технические качества:**
- Портируемость: контейнер работает на любой платформе с Docker.
- Мониторинг: визуализация помогает оценить качество обработки.

**Документирование:** 
- краткие описания файлов в папке Docker и в образе, размещенном в репозитории:
  - `api_app.py`: модуль для обработки аудиофайлов (транскрипция, шумоподавление, визуализация) и классификации текста с использованием моделей `Whisper-small` и `paraphrase-multilingual-MiniLM-L12-v2`
  - `api_server.py`: FastAPI-сервер для приема аудиофайлов, их транскрипции и классификации с асинхронной обработкой через Celery, включая API-аутентификацию и логирование
  - `demo_app.py`: Gradio-интерфейс для демонстрации классификации текста и транскрипции аудиофайлов с визуализацией результатов и кэшированием
  - `model.onnx`: оптимизированная ONNX-модель для классификации текста по категориям звонков.
  - `requirements.txt`: список зависимостей Python, необходимых для работы сервиса, включая библиотеки для аудиообработки, машинного обучения и веб-интерфейса
  - `supervisord.conf`: конфигурационный файл Supervisord для управления процессами API-сервера и демо-приложения в контейнере
  - `test_api.py`: модуль с тестами для проверки классификации текста и работы эндпоинта API
  - `Dockerfile`: файл сборки Docker-образа, включающий установку зависимостей, копирование моделей и настройку окружения для запуска сервиса.


---

#### Задача 5: Внедрение сервиса в бизнес-процесс

**Описание:**
- **API:** FastAPI эндпоинт `/classify-call/` (`api_server.py`) принимает `call_id` и звуковой файл (≤30 сек), возвращает JSON с транскрипцией, категорией и вероятностями.
- **Аутентификация:** API-ключ (`demo_key_123`) с лимитом 100 запросов, логирование в `api_server.log`.
- **Контейнеризация:** `Dockerfile` включает зависимости (`ffmpeg`, `redis-server`), кэш Hugging Face и модель Whisper.
- **Тестирование:** добавлен тест классификации текста по всем категориям (`test_api.py`).

**Предпосылки:**
- **Интеграция:** требование передачи данных в внешнюю систему определило REST API.
- **Безопасность:** запрет на внешние API привел к локальной реализации Whisper и SentenceTransformer.
- **Масштабируемость:** разделение на транскрипцию и классификацию с Celery поддерживает распределенное развертывание.

**Технические качества:**
- Портируемость: Docker-образ работает на любой платформе.
- Мониторинг: визуализация помогает оценить качество обработки.
- Надежность: обработка ошибок с логированием.
- Гибкость: легкое расширение через добавление контейнеров.

---


*(c) Андрей Кукунов*